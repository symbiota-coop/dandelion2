<% content_for :title, "Events" %>

<div class="container">
  <div class="d-hotwire-native-none mt-4">
    <h1>Events</h1>
  </div>

  <!-- Search Form -->
  <div class="row mt-3">
    <div class="col-12">
      <%= form_with url: events_path, method: :get, local: false, 
                    data: { 
                      turbo_frame: "events_content", 
                      turbo_action: "advance",
                      controller: "auto-submit" 
                    }, 
                    class: "row g-3" do |form| %>

        <!-- Search Text -->
        <div class="col-md-6">
          <%= form.text_field :search, 
              value: params[:search], 
              placeholder: "Search events by name, description, or location...", 
              class: "form-control",
              data: { action: "input->auto-submit#submit" } %>
        </div>

        <!-- Date Range -->
        <div class="col-md-3">
          <%= form.date_field :from, 
              value: @from, 
              class: "form-control",
              placeholder: "From date",
              data: { action: "change->auto-submit#submitImmediate" } %>
          <small class="text-muted">From date</small>
        </div>

        <div class="col-md-3">
          <%= form.date_field :to, 
              value: @to, 
              class: "form-control",
              placeholder: "To date",
              data: { action: "change->auto-submit#submitImmediate" } %>
          <small class="text-muted">To date</small>
        </div>

        <!-- Filters Row -->
        <div class="col-12">
          <div class="d-flex flex-wrap align-items-center gap-3">
            <!-- Online/In-person -->
            <div class="form-check">
              <%= form.check_box :online, 
                  { checked: params[:online] == "1", class: "form-check-input", 
                    data: { action: "change->auto-submit#submitImmediate" } }, 
                  "1", nil %>
              <%= form.label :online, "Online", class: "form-check-label" %>
            </div>

            <div class="form-check">
              <%= form.check_box :in_person, 
                  { checked: params[:in_person] == "1", class: "form-check-input",
                    data: { action: "change->auto-submit#submitImmediate" } }, 
                  "1", nil %>
              <%= form.label :in_person, "In-person", class: "form-check-label" %>
            </div>

            <!-- Sort Order -->
            <div class="d-flex align-items-center">
              <label class="form-label me-2 mb-0">Sort by:</label>
              <%= form.select :order, 
                  options_for_select([
                    ["Start time", "start_time"],
                    ["Recently added", "created_at"]
                  ], params[:order]), 
                  { include_blank: false }, 
                  { class: "form-select form-select-sm", style: "width: auto;",
                    data: { action: "change->auto-submit#submitImmediate" } } %>
            </div>

            <!-- View Select -->
            <div class="d-flex align-items-center">
              <label class="form-label me-2 mb-0">View:</label>
              <%= form.select :view, 
                  options_for_select([
                    ["ğŸ“‹ List", "list"],
                    ["ğŸ—ºï¸ Map", "map"]
                  ], params[:view] || "list"), 
                  { include_blank: false }, 
                  { class: "form-select form-select-sm", style: "width: auto;",
                    data: { action: "change->auto-submit#submitImmediate" } } %>
            </div>

            <!-- Buttons -->
            <div class="ms-auto d-flex gap-2">
              <!-- Search button hidden since form auto-submits -->
              <%= form.submit "Search", class: "btn btn-primary d-none" %>
            </div>
          </div>
        </div>

      <% end %>
    </div>
  </div>

  <%= turbo_frame_tag "events_content" do %>
    <% if params[:view] == 'map' %>
      <div class="mt-3">
        <%= render 'shared/map', stem: '/events', dynamic: true, points: @points, points_count: @points_count, centre: (OpenStruct.new(lat: @lat, lng: @lng) if @lat && @lng), zoom: @zoom, fill_screen: true %>
      </div>
    <% else %>
      <% if @events.any? %>
        <div class="row mt-4">
          <% @events.each do |event| %>
            <%= render 'event', event: event %>
          <% end %>
        </div>
      <% else %>
        <div class="text-center py-5">
          <i class="bi bi-calendar-x display-1 text-muted"></i>
          <h3 class="mt-3 text-muted">
            <% if params[:search].present? %>
              No events found
            <% else %>
              No events yet
            <% end %>
          </h3>
          <p class="text-muted">
            <% if params[:search].present? %>
              Try adjusting your search terms
            <% else %>
              Check back later for upcoming events!
            <% end %>
          </p>
        </div>
      <% end %>
    <% end %>
  <% end %>
</div>
